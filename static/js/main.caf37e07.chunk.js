(this.webpackJsonpexample=this.webpackJsonpexample||[]).push([[0],{133:function(e,t,n){e.exports=n(240)},138:function(e,t,n){},140:function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=140},145:function(e,t){},147:function(e,t){},157:function(e,t){},159:function(e,t){},186:function(e,t){},187:function(e,t){},192:function(e,t){},194:function(e,t){},218:function(e,t){},240:function(e,t,n){"use strict";n.r(t);var r,a=n(1),c=n.n(a),i=n(131),o=n.n(i),s=(n(138),function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,243)).then((function(t){var n=t.getCLS,r=t.getFID,a=t.getFCP,c=t.getLCP,i=t.getTTFB;n(e),r(e),a(e),c(e),i(e)}))}),u=n(0),l=n.n(u),f=n(2),h=n(6),p=n(242),d=n(19),v=n(20),m=n(7),b=n(3),y=n(10),w=n(52),O=n(17),g=n(18),k=n(45),j=n(15),E=n(132),A=n.n(E),S=n(43),x=n.n(S),C=n(42),P=n(34),L=n.n(P);!function(e){e.DISPATCH="DISPATCH",e.ACK="ACK",e.NACK="NACK",e.PROMOTE="PROMOTE",e.CANCEL="CANCEL",e.SET_STATE="SET_STATE",e.ASK_STATE="ASK_STATE",e.KICK="KICK"}(r||(r={}));var _,D=function(){function e(t){if(Object(y.a)(this,e),void 0!==t)this._options=t;else{var n='{"iceTransportPolicy":"all","iceServers":[{"urls":"stun:hkustracing.com:3478"},{"urls":"turn:hkustracing.com:3478","username":"player","credential":"player_password"}]}';this._options={host:null!=="peer.hkustracing.com"?"peer.hkustracing.com":"localhost",port:Number.parseInt(null!=="443"?"443":"9000",10),path:null!=="/"?"/":"/peer",secure:!0,config:JSON.parse(n)}}}return Object(j.a)(e,[{key:"make",value:function(e){return new A.a(e,this._options)}},{key:"makeAndOpen",value:function(){var e=Object(f.a)(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.make(t),e.next=3,new Promise((function(e,t){n.on("open",(function(){e(n)})),n.on("error",(function(){t(n)}))}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}(),R=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(){var e;return Object(y.a)(this,n),(e=t.apply(this,arguments)).message="already joined network",e.name="AlreadyJoinedNetworkError",e}return n}(Object(k.a)(Error)),N=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(e){var r;return Object(y.a)(this,n),(r=t.call(this)).name="PlayerNameAlreadyExistError",r.message="not connected to ".concat(e),r}return n}(Object(k.a)(Error)),T=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(){var e;return Object(y.a)(this,n),(e=t.apply(this,arguments)).message="No Staging State",e.name="NoStagingStateError",e}return n}(Object(k.a)(Error)),M=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(){var e;return Object(y.a)(this,n),(e=t.apply(this,arguments)).message="Network is busy, please retry later",e.name="NetworkBusyError",e}return n}(Object(k.a)(Error));!function(e){e[e.ALL=0]="ALL",e[e.TRACE=1]="TRACE",e[e.LOG=2]="LOG",e[e.DEBUG=3]="DEBUG",e[e.INFO=4]="INFO",e[e.WARN=5]="WARN",e[e.ERROR=6]="ERROR",e[e.OFF=7]="OFF"}(_||(_={}));var I=function(){function e(t,n,r){var a=this;Object(y.a)(this,e),this._logs=[],this.pushLog=function(e,t){a._logs.length>=a._keep&&a._logs.shift();for(var n=arguments.length,r=new Array(n>2?n-2:0),c=2;c<n;c++)r[c-2]=arguments[c];a._logs.push({level:e,message:r,date:new Date})},this.getLogFunction=function(e){if(e<a._verboseLevel)return function(){};switch(e){case _.INFO:return console.info.bind(window.console);case _.LOG:case _.DEBUG:return console.log.bind(window.console);case _.ERROR:return console.error.bind(window.console);case _.WARN:return console.warn.bind(window.console);case _.TRACE:return console.trace.bind(window.console);default:return function(){}}},this.withColor=function(e,t){return function(n){var r,a=(r={},Object(m.a)(r,_.INFO,"color: DodgerBlue"),Object(m.a)(r,_.LOG,""),Object(m.a)(r,_.DEBUG,"color: Green"),Object(m.a)(r,_.ERROR,""),Object(m.a)(r,_.WARN,""),Object(m.a)(r,_.TRACE,"color: Green"),Object(m.a)(r,_.ALL,""),Object(m.a)(r,_.OFF,""),r)[e],c=void 0===t?"%c[".concat(_[e],"]"):"%c[".concat(t.toISOString()," ").concat(_[e],"]");return Function.prototype.bind.call(n,console,c,a)}},this.withHistoryButWrongLineNumber=function(e){return function(t){return new Proxy(t,{apply:function(t,n,r){var c=new Date;return a.pushLog.apply(a,[e,c].concat(Object(w.a)(r))),t.apply(void 0,Object(w.a)(r))}})}},this.withAllFeatures=function(e){return e>=a._historyLevel?a.withHistoryButWrongLineNumber(e)(a.withColor(e)(a.getLogFunction(e))):a.withColor(e)(a.getLogFunction(e))},this.clear=function(){a._logs.splice(0,a._logs.length)},this.printLogs=function(){a._logs.forEach((function(e){var t=e.level,n=e.message,r=e.date;a.withColor(t,r)(a.getLogFunction(t)).apply(void 0,Object(w.a)(n))}))},this.getLogs=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_.ALL;return a._logs.filter((function(t){return t.level>=e}))},this._historyLevel=t,this._verboseLevel=n,this._keep=r}return Object(j.a)(e,[{key:"historyLevel",set:function(e){this._historyLevel=e}},{key:"verboseLevel",set:function(e){this._verboseLevel=e}},{key:"keep",set:function(e){this._keep=e}},{key:"info",get:function(){return this.withAllFeatures(_.INFO)}},{key:"log",get:function(){return this.withAllFeatures(_.LOG)}},{key:"debug",get:function(){return this.withAllFeatures(_.DEBUG)}},{key:"error",get:function(){return this.withAllFeatures(_.ERROR)}},{key:"warn",get:function(){return this.withAllFeatures(_.WARN)}},{key:"trace",get:function(){return this.withAllFeatures(_.TRACE)}}]),e}(),K=new I(_.ALL,_.WARN,100);K.historyLevel=_.OFF,K.verboseLevel=_.ALL;var F,H,B=function(){function e(t,n){Object(y.a)(this,e),this.isAdmin=!0,this.leaving=!1,this.network=t,this.peerFactory=n}return Object(j.a)(e,[{key:"handlePromote",value:function(){var e=Object(f.a)(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.stagingState){e.next=12;break}if((n=x()(JSON.stringify(this.stagingState)))!==t){e.next=8;break}this.network.setState(this.stagingState),K.info("promoted the stagingState",this.stagingState),this.stagingState=void 0,e.next=10;break;case 8:throw K.error("Cannot promote, staging checksum is ".concat(n," while requested to promote checksum of ").concat(t)),new Error("Cannot promote staging state with unmatched checksum");case 10:e.next=14;break;case 12:throw K.error("Cannot promote, there is no staging state"),new T;case 14:return e.next=16,Promise.resolve();case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handleCancel",value:function(){var e=Object(f.a)(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.stagingState){e.next=11;break}if((n=x()(JSON.stringify(this.stagingState)))!==t){e.next=7;break}K.info("canceled the stagingState",this.stagingState),this.stagingState=void 0,e.next=9;break;case 7:throw K.error("Cannot cancel, staging checksum is ".concat(n," while requested to cancel checksum of ").concat(t)),new Error("Cannot cancel staging state with unmatched checksum");case 9:e.next=13;break;case 11:throw K.error("Cannot cancel, there is no staging state"),new T;case 13:return e.next=15,Promise.resolve();case 15:return e.abrupt("return",e.sent);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"forceCancel",value:function(){K.info("force cancel the stagingState"),this.stagingState=void 0}},{key:"isBusy",value:function(){return void 0!==this.stagingState}}]),e}(),U=function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){setTimeout((function(){e()}),t)}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),G=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(){return Object(y.a)(this,n),t.apply(this,arguments)}return Object(j.a)(n,[{key:"dispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t){var n,a,c,i,o,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this,K.debug("reduce locally",this.network.getState(),t),this.stagingState=this.network.applyReducer(this.network.getState(),t),a=x()(JSON.stringify(this.stagingState)),K.debug("stagingState",this.stagingState),e.next=7,this.network.broadcast(r.DISPATCH,t);case 7:if(c=e.sent,K.debug("obtained responses",c),i=[],o=[],s=[],c.forEach((function(e){var t=e.conn,n=e.data,r=e.error;void 0!==r?i.push({error:r,conn:t}):n!==a?o.push(t):s.push(t)})),s.length===c.length?K.debug("all can be promoted"):(i.length>0&&K.error("received ".concat(i.length," error from some peers"),i),o.length>0&&K.warn("received ".concat(o.length," unmatched checksum from some peer, forceUpdating them"),o)),!(i.length>0)){e.next=20;break}return e.next=17,this.network.broadcast(r.CANCEL,a);case 17:throw new Error(i[0].error);case 20:o.map(function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.network.send(t,r.SET_STATE,n.stagingState);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),s.map(function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.network.send(t,r.PROMOTE,a);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 22:return e.next=24,this.handlePromote(a);case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handleDispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dispatch(n);case 2:return e.abrupt("return",this.network.getState());case 3:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"setUpConnection",value:function(e){var t=this;e.on("close",(function(){t.dispatchMemberLeft(e.peer).catch(K.error)}))}},{key:"dispatchMemberLeft",value:function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.leaving){e.next=12;break}return e.prev=1,e.next=4,this.network.dispatch({type:"member-left",payload:t});case 4:e.next=12;break;case 6:return e.prev=6,e.t0=e.catch(1),e.next=10,U(1e3);case 10:return e.next=12,this.dispatchMemberLeft(t);case 12:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(t){return e.apply(this,arguments)}}()}]),n}(B),W=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(){var e;return Object(y.a)(this,n),(e=t.apply(this,arguments)).isAdmin=!1,e}return Object(j.a)(n,[{key:"dispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.broadcast(r.DISPATCH,t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handleDispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.stagingState=this.network.applyReducer(t,n),e.next=3,Promise.resolve(this.stagingState);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"setUpConnection",value:function(e){var t=this;e.on("close",(function(){t.leaving||t.recover().catch(K.error)}))}},{key:"recover",value:function(){var e=Object(f.a)(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===(t=this.network.getNetworkName())){e.next=17;break}return e.prev=2,n=this.network.myId,K.debug("oldId",n),e.next=7,this.network.initAsStarHost(t,this.peerFactory);case 7:if(K.info("became the new host, changed peerId, notify others"),void 0===n){e.next=11;break}return e.next=11,this.dispatchHostLeft(n);case 11:e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(2),e.next=17,this.network.reconnectToHost(t);case 17:case"end":return e.stop()}}),e,this,[[2,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"dispatchHostLeft",value:function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.network.dispatch({type:"host-left",payload:t});case 3:e.next=11;break;case 5:return e.prev=5,e.t0=e.catch(0),e.next=9,U(1e3);case 9:return e.next=11,this.dispatchHostLeft(t);case 11:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()}]),n}(B),Y=function(){function e(){Object(y.a)(this,e),this.connections={},this.sentPromises={}}return Object(j.a)(e,[{key:"reset",value:function(){this.connections={}}},{key:"registerConnection",value:function(e){this.connections[e.peer]=e}},{key:"unregisterConnection",value:function(e){var t=this.connections,n=e.peer,r=(t[n],Object(d.a)(t,[n].map(v.a)));this.connections=r}},{key:"getConnections",value:function(){return this.connections}},{key:"send",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n,r){var a,c=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this.getConn(t),e.next=3,new Promise((function(e,t){var i=Object(C.v4)();c.sentPromises[i]={resolve:function(t){return e({conn:a,data:t})},reject:function(e){return t(new Error(e))}},a.send({pkgType:n,data:r,pid:i})}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"sendACK",value:function(e,t,n){this.getConn(e).send({pkgType:r.ACK,pid:t,data:n})}},{key:"sendNACK",value:function(e,t,n){this.getConn(e).send({pkgType:r.NACK,pid:t,data:n})}},{key:"broadcast",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){var r,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this,a=Object.keys(this.connections).map(function(){var e=Object(f.a)(l.a.mark((function e(a){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.send(a,t,n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=4,Promise.all(a);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"receiveACK",value:function(e,t){void 0!==e&&e in this.sentPromises&&((0,this.sentPromises[e].resolve)(t),this.removeSentPromise(e))}},{key:"receiveNACK",value:function(e,t){void 0!==e&&e in this.sentPromises&&((0,this.sentPromises[e].reject)(t),this.removeSentPromise(e))}},{key:"removeSentPromise",value:function(e){var t=this.sentPromises,n=(t[e],Object(d.a)(t,[e].map(v.a)));this.sentPromises=n}},{key:"getConn",value:function(e){if("string"===typeof e){var t=this.connections[e];if(void 0!==t)return t;throw new N(e)}return e}}]),e}(),V=function(){function e(t,n){var r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Object(y.a)(this,e),this.history=[],this.historyMax=a,this.initialState=L()(t),this._reset=function(){return r.set(L()(r.initialState))},this.state=t,this._set=null!==n&&void 0!==n?n:function(e){r.state=e}}return Object(j.a)(e,[{key:"get",value:function(){return this.state}},{key:"set",value:function(e){this.state=e,this.historyMax>0&&(this.history.length>=this.historyMax&&this.history.shift(),this.history.push(L()(e))),this._set(Object(b.a)({},e))}},{key:"reset",value:function(){this._reset()}},{key:"getHistory",value:function(){return this.history}}],[{key:"make",value:function(t,n,r){return new e(t,n,r)}}]),e}(),J=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(){return Object(y.a)(this,n),t.apply(this,arguments)}return Object(j.a)(n,[{key:"dispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.stagingState){e.next=3;break}throw K.error("cannot dispatch when there is staging state",this.stagingState),new M;case 3:return e.next=5,this.wrappedStrategy.dispatch(t);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handleDispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.stagingState){e.next=3;break}throw K.error("cannot handle dispatch request when there is staging state",this.stagingState),new M;case 3:return e.next=5,this.wrappedStrategy.handleDispatch(t,n);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),n}(function(){function e(t){Object(y.a)(this,e),this.wrappedStrategy=t}return Object(j.a)(e,[{key:"dispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wrappedStrategy.dispatch(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"forceCancel",value:function(){return this.wrappedStrategy.forceCancel()}},{key:"handleCancel",value:function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wrappedStrategy.handleCancel(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handleDispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wrappedStrategy.handleDispatch(t,n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"handlePromote",value:function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wrappedStrategy.handlePromote(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"isBusy",value:function(){return this.wrappedStrategy.isBusy()}},{key:"setUpConnection",value:function(e){return this.wrappedStrategy.setUpConnection(e)}},{key:"stagingState",get:function(){return this.wrappedStrategy.stagingState},set:function(e){this.wrappedStrategy.stagingState=e}},{key:"network",get:function(){return this.wrappedStrategy.network}},{key:"leaving",get:function(){return this.wrappedStrategy.leaving},set:function(e){this.wrappedStrategy.leaving=e}},{key:"isAdmin",get:function(){return this.wrappedStrategy.isAdmin},set:function(e){this.wrappedStrategy.isAdmin=e}}]),e}()),q=function(e){return new J(e)},z=function(){function e(t,n){var a=this;Object(y.a)(this,e);var c=this;this.dataStream=new Y,this.getHistory=function(){return a.stateManager.getHistory()},this.kick=function(){var e=Object(f.a)(l.a.mark((function e(t){var n,a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(n=null===(a=c.getNeighbor())||void 0===a?void 0:a.includes(t))||void 0===n||!n){e.next=5;break}return e.next=3,c.send(t,r.KICK,t);case 3:e.next=7;break;case 5:return e.next=7,c.broadcast(r.KICK,t);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.stateManager=n instanceof V?n:V.make(n),this.stateReducer=t}return Object(j.a)(e,[{key:"getNetworkName",value:function(){return this.networkName}},{key:"setState",value:function(e){this.stateManager.set(e)}},{key:"getState",value:function(){return this.stateManager.get()}},{key:"applyReducer",value:function(e,t){return this.stateReducer(e,t)}},{key:"reduce",value:function(e){this.stateManager.set(this.stateReducer(this.stateManager.get(),e))}},{key:"leave",value:function(){var e=Object(f.a)(l.a.mark((function e(){var t,n=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.peer){e.next=10;break}return void 0!==this.networkStrategy&&(this.networkStrategy.leaving=!0),t=new Promise((function(e){var t;return null===(t=n.peer)||void 0===t?void 0:t.on("close",e)})),this.peer.destroy(),e.next=6,t;case 6:this.peer=void 0,this.networkName=void 0,this.dataStream.reset(),this.stateManager.reset();case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"join",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){var r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.peer){e.next=2;break}throw new R;case 2:return n=null!==(r=n)&&void 0!==r?r:new D,e.prev=3,e.next=6,this.initAsStarHost(t,n);case 6:this.stateManager.reset(),this.setState(Object(b.a)(Object(b.a)({},this.getState()),{},{networkName:t})),e.next=15;break;case 10:return e.prev=10,e.t0=e.catch(3),K.info("cannot init as host, try to init as member"),e.next=15,this.initAsStarMember(t,n);case 15:return e.next=17,this.dispatch({type:"member-join"});case 17:case"end":return e.stop()}}),e,this,[[3,10]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"initAsStarHost",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){var r,a=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return K.info("initing as host"),r=this.peer,e.next=4,n.makeAndOpen(t);case 4:this.peer=e.sent,this.peer.on("connection",(function(e){K.info("received connection with",e.peer),a.setUpConnection(e)})),this.networkName=t,this.networkStrategy=q(new G(this,n)),null===r||void 0===r||r.destroy(),K.info("inited as host");case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"initAsStarMember",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return K.info("initing as member"),this.networkStrategy=q(new W(this,n)),e.next=4,n.makeAndOpen();case 4:return this.peer=e.sent,K.info("opened peer"),e.next=8,this.reconnectToHost(t);case 8:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"reconnectToHost",value:function(){var e=Object(f.a)(l.a.mark((function e(t){var n,a,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.peer){e.next=2;break}return e.abrupt("return");case 2:return n=this.peer.connect(t),this.setUpConnection(n),e.next=6,new Promise((function(e,t){n.on("open",(function(){e()})),n.on("error",(function(e){t(e)}))}));case 6:return K.info("opened connection with host"),this.dataStream.registerConnection(n),this.networkName=t,K.info("requesting state from host"),e.next=12,this.dataStream.send(t,r.ASK_STATE,void 0);case 12:a=e.sent,void 0!==(c=a.data)&&(K.info("updating the state got from host",c),this.setState(c)),K.info("inited as member");case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getNeighbor",value:function(){if(void 0!==this.peer)return Object.keys(this.dataStream.getConnections())}},{key:"send",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n,r){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataStream.send(t,n,r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"broadcast",value:function(){var e=Object(f.a)(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataStream.broadcast(t,n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"dispatch",value:function(){var e=Object(f.a)(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.peerId=this.myId,void 0===this.myId||null===this.myId){e.next=8;break}return K.info("dispatching action",t),e.next=5,null===(n=this.networkStrategy)||void 0===n?void 0:n.dispatch(t);case 5:K.info("dispatched action",t),e.next=9;break;case 8:K.error("not connected");case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setUpConnection",value:function(e){var t,n=this;e.on("open",(function(){K.info("opened connection with",e.peer),n.dataStream.registerConnection(e)})),e.on("close",(function(){K.info("closed connection with",e.peer),n.dataStream.unregisterConnection(e)})),e.on("data",(function(t){return n.dataHandler(t,e)})),null===(t=this.networkStrategy)||void 0===t||t.setUpConnection(e)}},{key:"dataHandler",value:function(e,t){var n,a,c,i,o=this,s=e.pid,u=e.pkgType,l=e.data;switch(K.debug("received pkg from",t.peer,e),u){case r.DISPATCH:null===(n=this.networkStrategy)||void 0===n||n.handleDispatch(this.getState(),l).then((function(e){var n=x()(JSON.stringify(e));o.dataStream.sendACK(t,s,n)})).catch((function(e){o.dataStream.sendNACK(t,s,e.message)}));break;case r.ACK:this.dataStream.receiveACK(s,l);break;case r.NACK:this.dataStream.receiveNACK(s,l);break;case r.PROMOTE:null===(a=this.networkStrategy)||void 0===a||a.handlePromote(l).then((function(){return o.dataStream.sendACK(t,s,l)})).catch((function(e){return o.dataStream.sendNACK(t,s,e.message)}));break;case r.CANCEL:null===(c=this.networkStrategy)||void 0===c||c.handleCancel(l).then((function(){return o.dataStream.sendACK(t,s,l)})).catch((function(e){return o.dataStream.sendNACK(t,s,e.message)}));break;case r.SET_STATE:this.setState(l),null===(i=this.networkStrategy)||void 0===i||i.forceCancel();break;case r.ASK_STATE:this.dataStream.sendACK(t,s,this.state);break;case r.KICK:l===this.myId?(K.info("you got kicked out of network"),this.leave().catch(K.error)):this.send(l,u,l).catch(K.error)}}},{key:"myId",get:function(){var e;return null===(e=this.peer)||void 0===e?void 0:e.id}},{key:"connected",get:function(){return void 0!==this.networkName}},{key:"state",get:function(){return this.getState()}},{key:"isAdmin",get:function(){var e,t;return null!==(e=null===(t=this.networkStrategy)||void 0===t?void 0:t.isAdmin)&&void 0!==e&&e}}]),e}();!function(e){e.MEMBER_JOIN="member-join",e.MEMBER_LEFT="member-left",e.HOST_LEFT="host-left",e.RENAME="rename",e.READY="ready",e.START="start",e.ADD_AI="add-ai",e.ADD_LOCAL="add-local",e.REMOVE_LOCAL_AI="remove-local-ai"}(F||(F={})),function(e){e[e.NORMAL=0]="NORMAL",e[e.LOCAL=1]="LOCAL",e[e.AI=2]="AI"}(H||(H={}));var Q,X=function e(){Object(y.a)(this,e),this.minPlayer=1,this.maxPlayer=4,this.members={},this.spectators={},this.localPlayers={},this.aiPlayers={},this.nameDict={},this.players=[],this.ready={},this.started=!1},Z=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return t.reverse().reduce((function(e,t){return t(e)}),e)}},$=function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),r=[e[n],e[t]];e[t]=r[0],e[n]=r[1]}return e},ee=function(e){return function(t){if(e in t.members)throw new Error("peerId ".concat(e," already joined this room"));return(t.maxPlayer>0&&Object.values(t.members).length>=t.maxPlayer||t.started)&&(t.spectators[e]=!0),Object(b.a)(Object(b.a)({},t),{},{members:Object(b.a)(Object(b.a)({},t.members),{},Object(m.a)({},e,""))})}},te=function(e,t){return function(n){if(Object.values(n.members).includes(t))throw new Error("there is already someone named ".concat(t));if(n.started&&Object.keys(n.nameDict).includes(t)){var r=n.spectators,a=(r[e],Object(d.a)(r,[e].map(v.a)));n.spectators=a}return Object(b.a)(Object(b.a)({},n),{},{members:Object(b.a)(Object(b.a)({},n.members),{},Object(m.a)({},e,t))})}},ne=function(e,t){return function(n){var r={},a={};return Object.entries(n.localPlayers).forEach((function(n){var a=Object(h.a)(n,2),c=a[0],i=a[1];i!==e?r[c]=i:void 0!==t&&(r[c]=t)})),Object.entries(n.aiPlayers).forEach((function(n){var r=Object(h.a)(n,2),c=r[0],i=r[1];i!==e?a[c]=i:void 0!==t&&(a[c]=t)})),Object(b.a)(Object(b.a)({},n),{},{localPlayers:r,aiPlayers:a})}},re=function(e){return function(t){var n=t.members,r=(n[e],Object(d.a)(n,[e].map(v.a))),a=t.localPlayers,c=(a[e],Object(d.a)(a,[e].map(v.a))),i=t.aiPlayers,o=(i[e],Object(d.a)(i,[e].map(v.a)));return Object(b.a)(Object(b.a)({},t),{},{members:r,localPlayers:c,aiPlayers:o})}},ae=function(e){return function(t){if(t.started)throw new Error("Started already");var n=Object.keys(t.members).filter((function(t){return t!==e})).filter((function(e){return!t.spectators[e]})).filter((function(e){return void 0===t.localPlayers[e]})).filter((function(e){return void 0===t.aiPlayers[e]})).filter((function(e){var n;return void 0!==e&&!(null!==(n=t.ready[e])&&void 0!==n&&n)}));if(0===n.length)return function(e){var t=$(Object.entries(e.members).filter((function(t){var n=Object(h.a)(t,1)[0];return!e.spectators[n]})).map((function(e){return e[1]})));if(t.length>e.maxPlayer)throw new Error("Too much players, max: ".concat(e.maxPlayer,", got: ").concat(t.length));if(t.length<e.minPlayer)throw new Error("Not enough players, min: ".concat(e.minPlayer,", got: ").concat(t.length));var n={};return t.forEach((function(e,t){n[e]=t})),Object(b.a)(Object(b.a)({},e),{},{nameDict:n,players:t})}(Object(b.a)(Object(b.a)({},t),{},{started:!0}));throw new Error("".concat(n.map((function(e){return t.members[e]})).join(",")," not ready yet"))}},ce=function(e,t){var n=t.peerId;if(void 0===n)throw new Error("expect peerId in action");var r,a,c=e.networkName;if(void 0===c)throw new Error("expect networkName in prevState");switch(t.type){case F.MEMBER_JOIN:return ee(n)(e);case F.RENAME:return te(n,t.payload)(e);case F.MEMBER_LEFT:return Z(ne(t.payload,c),re(t.payload))(e);case F.HOST_LEFT:return Z(ne(t.payload,c),te(c,e.members[t.payload]),re(t.payload))(e);case F.READY:return function(e){return function(t){if(t.ready[e]){var n=t.ready,r=(n[e],Object(d.a)(n,[e].map(v.a)));return Object(b.a)(Object(b.a)({},t),{},{ready:r})}return Object(b.a)(Object(b.a)({},t),{},{ready:Object(b.a)(Object(b.a)({},t.ready),{},Object(m.a)({},e,!0))})}}(n)(e);case F.START:return ae(c)(e);case F.ADD_AI:return(r=t.payload,a=n,function(e){var t="ai-".concat(r,"-").concat(Object(C.v4)()),n=Z(te(t,r),ee(t))(e);return Object(b.a)(Object(b.a)({},n),{},{aiPlayers:Object(b.a)(Object(b.a)({},n.aiPlayers),{},Object(m.a)({},t,a))})})(e);case F.ADD_LOCAL:return function(e,t){return function(n){var r="local-".concat(e,"-").concat(Object(C.v4)()),a=Z(te(r,e),ee(r))(n);return Object(b.a)(Object(b.a)({},a),{},{localPlayers:Object(b.a)(Object(b.a)({},a.localPlayers),{},Object(m.a)({},r,t))})}}(t.payload,n)(e);case F.REMOVE_LOCAL_AI:return re(t.payload)(e);default:return e}};!function(e){e[e.HOME=0]="HOME",e[e.ROOM=1]="ROOM",e[e.GAME=2]="GAME"}(Q||(Q={}));var ie,oe,se=function(e,t){var n=Object(a.useState)(Q.HOME),r=Object(h.a)(n,2),c=r[0],i=r[1],o=function(e,t){var n=Object(a.useState)(t),r=Object(h.a)(n,2),c=r[0],i=r[1],o=Object(a.useMemo)((function(){return new z(e,V.make(t,i,10))}),[]);return Object(a.useEffect)((function(){return void 0===Object({NODE_ENV:"production",PUBLIC_URL:"/smnet",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,REACT_APP_PEER_CONFIG:'{"iceTransportPolicy":"all","iceServers":[{"urls":"stun:hkustracing.com:3478"},{"urls":"turn:hkustracing.com:3478","username":"player","credential":"player_password"}]}',REACT_APP_PEER_HOST:"peer.hkustracing.com",REACT_APP_PEER_PATH:"/",REACT_APP_PEER_PORT:"443",REACT_APP_PEER_SECURE:"true",REACT_APP_SMNET_VERBOSE_ALL_NO_HISTORY:"true"}).REACT_APP_DISABLE_SMNET_WINDOW_VAR&&(window.stateHistory=o.getHistory,window.smnetLog=K,window.network=o),function(){o.leave().catch(K.error)}}),[o]),Object.freeze({join:o.join.bind(o),leave:o.leave.bind(o),dispatch:o.dispatch.bind(o),state:c,connected:o.connected,networkName:o.getNetworkName(),isAdmin:o.isAdmin,myId:o.myId,kick:o.kick})}(function(e){return function(t,n){return e(ce(t,n),n)}}(e),t),s=function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.dispatch({type:F.RENAME,payload:t});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),u=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.dispatch({type:F.READY});case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),p=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.dispatch({type:F.START});case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),d=function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.dispatch({type:F.ADD_LOCAL,payload:t});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),v=function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.dispatch({type:F.ADD_AI,payload:t});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),m=function(){var e=Object(f.a)(l.a.mark((function e(t,n){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,K.info("connecting",n),e.next=4,o.join(n);case 4:return K.info("entering with name",t),e.next=7,s(t);case 7:K.info("connected",n),e.next=16;break;case 10:return e.prev=10,e.t0=e.catch(0),K.error(e.t0),e.next=15,b();case 15:throw e.t0;case 16:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n){return e.apply(this,arguments)}}(),b=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return K.info("leaving"),e.next=3,o.leave();case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),y=function(){var e=Object(f.a)(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(K.info("leaving"),!(t in o.state.aiPlayers)&&!(t in o.state.localPlayers)){e.next=6;break}return e.next=4,o.dispatch({type:F.REMOVE_LOCAL_AI,payload:t});case 4:e.next=8;break;case 6:return e.next=8,o.kick(t);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return Object(a.useEffect)((function(){o.state.started&&void 0!==o.networkName?i(Q.GAME):void 0!==o.networkName?i(Q.ROOM):i(Q.HOME)}),[o.state,o.networkName]),{connect:m,gameAppState:c,state:o.state,room:o.networkName,leave:b,isAdmin:o.isAdmin,myId:o.myId,kick:y,ready:u,start:p,dispatch:o.dispatch,addLocal:d,addAi:v,playerType:function(e){var t,n="string"===typeof e?e:o.state.players[e],r=null===(t=Object.entries(o.state.members).find((function(e){var t=Object(h.a)(e,2),r=(t[0],t[1]);return n===r})))||void 0===t?void 0:t[0];return void 0===r?H.NORMAL:r in o.state.aiPlayers?H.AI:r in o.state.localPlayers?H.LOCAL:H.NORMAL}}},ue=function(e){Object(O.a)(n,e);var t=Object(g.a)(n);function n(){var e;Object(y.a)(this,n);for(var r=arguments.length,a=new Array(r),c=0;c<r;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).maxPlayer=4,e.minPlayer=4,e.turn=0,e.direction=1,e.points=0,e.dead={},e.drawDeck=[],e.trashDeck=[],e.playerDeck=[],e.winner=void 0,e.logs=[],e}return n}(X);!function(e){e[e.PLAY_CARD=0]="PLAY_CARD",e[e.LOCAL_MOVE=1]="LOCAL_MOVE",e[e.END=2]="END"}(ie||(ie={})),function(e){e[e.SPADE=0]="SPADE",e[e.HEART=1]="HEART",e[e.CLUB=2]="CLUB",e[e.DIAMOND=3]="DIAMOND"}(oe||(oe={}));var le={1:1,2:2,3:3,4:0,5:0,6:6,7:7,8:8,9:9,10:10,11:0,12:20,13:99},fe=function e(t){return function(n){if(n.playerDeck[t].length>=5)throw new Error("cannot draw, ".concat(n.players[t]," already has ").concat(5," cards"));var r=n.drawDeck.shift();return void 0===r?e(t)(Object(b.a)(Object(b.a)({},n),{},{drawDeck:$(n.trashDeck),trashDeck:[]})):(n.playerDeck[t].push(r),Object(b.a)({},n))}},he=function(e){var t=(e.turn+e.maxPlayer+e.direction)%e.maxPlayer;return Object(b.a)(Object(b.a)({},e),{},{turn:t})},pe=function e(t){return!t.dead[t.turn]&&function(e,t){var n=1/0,r=0;return t.forEach((function(t,a){var c=t.suit,i=t.number,o=0;if(c===oe.SPADE&&1===i)return[0,a];(o=10===i?e-10:12===i?e-20:13===i?99:e+le[i])<n&&(n=o,r=a)})),[n,r]}(t.points,t.playerDeck[t.turn])[0]>99&&(t.logs.push("".concat(t.players[t.turn]," die, his card: ").concat(t.playerDeck[t.turn].map((function(e){return"".concat(oe[e.suit]).concat(e.number)})).join(","))),t.dead[t.turn]=!0),Object.keys(t.dead).length===t.players.length-1&&t.started&&(t.winner=[0,1,2,3].filter((function(e){return!t.dead[e]}))[0]),t.dead[t.turn]?e(he(Object(b.a)(Object(b.a)({},t),{},{turn:t.turn}))):Object(b.a)(Object(b.a)({},t),{},{turn:t.turn})},de=function e(t,n){console.log("poker99 reducer");var r=n.peerId;if(void 0===r)throw new Error("Expect peerId in action");switch(n.type){case F.START:return function(e){(e=Object(b.a)(Object(b.a)({},e),{},{drawDeck:[],trashDeck:[],playerDeck:[],points:0,direction:1,turn:0,dead:{},logs:["game started"],winner:void 0})).drawDeck=$(function(){for(var e=[],t=0;t<4;t++)for(var n=1;n<=13;n++)e.push({suit:t,number:n});return e}());for(var t=0;t<e.players.length;t++){e.playerDeck[t]=[];for(var n=0;n<5;n++)e=fe(t)(e)}return Object(b.a)({},e)}(t);case ie.PLAY_CARD:return function(e,t){return function(n){var r=t.card,a="".concat(oe[r.suit]).concat(r.number);if(void 0===n.playerDeck[e].find((function(e){var t=e.suit,n=e.number;return t===r.suit&&n===r.number})))throw new Error("".concat(n.players[e]," doesnt own card ").concat(a));if(n.turn!==e)throw new Error("not your turn");var c=1,i=le[r.number];if(10===r.number||12===r.number){if(void 0===t.increase)throw new Error("card with number 10 or 12 require increase in payload");c=t.increase?1:-1}else 13===r.number?i=99-n.points:1===r.number&&r.suit===oe.SPADE&&(c=-1,i=n.points-1);if(n.points+=c*i,n.points>99)throw new Error("playing this card will exceed 99");if(n.playerDeck[e]=n.playerDeck[e].filter((function(e){var t=e.suit,n=e.number;return!(t===r.suit&&n===r.number)})),n.trashDeck.push(r),n=fe(e)(n),5===r.number){if(void 0===t.target)throw new Error("Card with number 5 require target in payload");if(t.target===e)throw new Error("Target cannot be myself");if(n.dead[t.target])throw new Error("cannot target on dead body");return n.logs.push("".concat(n.players[n.turn]," played ").concat(a,", targeted ").concat(n.players[t.target])),n.turn=t.target,pe(n)}return 4===r.number?(n.direction*=-1,n.logs.push("".concat(n.players[n.turn]," played ").concat(a,", direction reversed"))):n.logs.push("".concat(n.players[n.turn]," played ").concat(a,", add ").concat(c*i,", now ").concat(n.points," points")),pe(he(n))}}(function(){var e=t.nameDict[t.members[r]];if(void 0===e)throw new Error("game not started");return e}(),n.payload)(L()(t));case ie.LOCAL_MOVE:return e(t,n.payload);case ie.END:return Object(b.a)(Object(b.a)({},t),{},{started:!1})}return t},ve=Object(a.createContext)(null),me=function(){var e=Object(a.useContext)(ve);if(null===e)throw new Error("please wrap it using withPoker99Network before calling this hook");return e},be=function(){var e=me().connect,t=Object(a.useState)(Object(p.a)().substring(0,4)),n=Object(h.a)(t,2),r=n[0],i=n[1],o=Object(a.useState)("my-room"),s=Object(h.a)(o,2),u=s[0],d=s[1],v=Object(a.useState)(""),m=Object(h.a)(v,2),b=m[0],y=m[1];return c.a.createElement("div",null,c.a.createElement("h1",null,"Demo Game - Poker 99"),""!==b&&c.a.createElement("div",null,b),c.a.createElement("div",null,c.a.createElement("label",null,"your name: ",c.a.createElement("input",{value:r,onChange:function(e){var t=e.target.value;return i(t)}}))),c.a.createElement("div",null,c.a.createElement("label",null,"room code: ",c.a.createElement("input",{value:u,onChange:function(e){var t=e.target.value;return d(t)}}))),c.a.createElement("button",{disabled:""===r||""===u,onClick:Object(f.a)(l.a.mark((function t(){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e(r,u).catch((function(e){return y(e.message)}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))},"join"))},ye=function(){var e,t=me(),n=t.room,r=t.state,i=t.leave,o=t.isAdmin,s=t.myId,u=t.kick,p=t.ready,d=t.start,v=t.addAi,b=t.addLocal,y=t.playerType,w=Object(a.useState)(""),O=Object(h.a)(w,2),g=O[0],k=O[1],j=Object(a.useState)(""),E=Object(h.a)(j,2),A=E[0],S=E[1],x=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d().catch((function(e){return k(e.message)}));case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),C=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p().catch((function(e){return k(e.message)}));case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),P=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return S(""),e.next=3,b(A).catch((function(e){return k(e.message)}));case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),L=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return S(""),e.next=3,v(A).catch((function(e){return k(e.message)}));case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),_=(e={},Object(m.a)(e,H.NORMAL,""),Object(m.a)(e,H.LOCAL,"(local)"),Object(m.a)(e,H.AI,"(ai)"),e);return c.a.createElement("div",null,c.a.createElement("div",null,"Room: ",n),c.a.createElement("div",null,Object.entries(r.members).map((function(e){var t,n=Object(h.a)(e,2),a=n[0],i=n[1];return c.a.createElement("div",{key:i},i," ",_[y(i)],a!==s&&o&&c.a.createElement("button",{onClick:Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u(a);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))},"kick"),null!==(t=r.ready[a])&&void 0!==t&&t&&"(ready)")}))),c.a.createElement("div",null,c.a.createElement("button",{onClick:i},"leave"),o?c.a.createElement("button",{onClick:x},"start"):c.a.createElement("button",{onClick:C},"ready")),c.a.createElement("div",null,c.a.createElement("input",{placeholder:"new local/ai player name",value:A,onChange:function(e){var t=e.target.value;return S(t)}}),c.a.createElement("button",{onClick:P},"Add local"),c.a.createElement("button",{onClick:L},"Add AI")),""!==g&&c.a.createElement("div",null,g))},we=n(44),Oe=function(e){return(e.suit!==oe.SPADE||1!==e.number)&&[1,2,3,6,7,8,9].includes(e.number)},ge=function(e){return[10,12].includes(e.number)},ke=function(e){return[4,5,11,13].includes(e.number)},je=function(){var e=me(),t=e.state,n=e.myId,r=e.dispatch,i=Object(a.useState)(0),o=Object(h.a)(i,2),s=o[0],u=o[1],p=Object(a.useState)(!0),d=Object(h.a)(p,2),v=d[0],m=d[1],b=Object(a.useState)(""),y=Object(h.a)(b,2),w=y[0],O=y[1],g=Object(a.useMemo)((function(){try{return t.nameDict[t.members[n]]}catch(e){return 0}}),[n,t]),k=Object(a.useMemo)((function(){try{return Object.keys(t.localPlayers).filter((function(e){return t.localPlayers[e]===n})).map((function(e){return t.members[e]}))}catch(e){return[]}}),[n,t]),j=Object(a.useMemo)((function(){try{return Object.keys(t.aiPlayers).filter((function(e){return t.aiPlayers[e]===n})).map((function(e){return t.members[e]}))}catch(e){return[]}}),[n,t]),E=Object(a.useState)(k.length>0),A=Object(h.a)(E,2),S=A[0],x=A[1],C=Object(a.useState)(g),P=Object(h.a)(C,2),L=P[0],_=P[1],D=Object(a.useRef)(-1);t.turn!==D.current&&(k.length>0&&(S=!0,x(!0),_(t.turn)),D.current=t.turn);var R=function(e){O(e.message)};Object(a.useEffect)((function(){if(j.includes(t.players[t.turn])&&t.started&&void 0===t.winner){var e=window.setTimeout((function(){var e=function(e,t){var n=e.playerDeck[t],r=e.points,a=n.filter(Oe).sort((function(e,t){return le[t.number]-le[e.number]}));console.log("normal cards",a,"points",r);var c=n.find((function(e){return 13===e.number}));if(void 0!==c&&99!==r&&a.length<3)return{type:ie.PLAY_CARD,payload:{card:c}};var i,o=Object(we.a)(a);try{for(o.s();!(i=o.n()).done;){var s=i.value;if(console.log("should play normal?",s,r+le[s.number]<=99),r+le[s.number]<=99)return{type:ie.PLAY_CARD,payload:{card:s}}}}catch(O){o.e(O)}finally{o.f()}var u,l=n.filter(ge),f=Object(we.a)(l.sort((function(e,t){return t.number-e.number})));try{for(f.s();!(u=f.n()).done;){var h=u.value;if(r+le[h.number]<=99)return{type:ie.PLAY_CARD,payload:{card:h,increase:!0}}}}catch(O){f.e(O)}finally{f.f()}var p=n.find(ke);if(void 0!==p)return{type:ie.PLAY_CARD,payload:{card:p,target:e.nameDict[$(e.players.filter((function(n,r){return!e.dead[r]&&r!==t})))[0]]}};var d,v=Object(we.a)(l.sort((function(e,t){return e.number-t.number})));try{for(v.s();!(d=v.n()).done;){var m=d.value;if(r-le[m.number]<=99)return{type:ie.PLAY_CARD,payload:{card:m,increase:!1}}}}catch(O){v.e(O)}finally{v.f()}var b,y=Object(we.a)(n);try{for(y.s();!(b=y.n()).done;){var w=b.value;if(r-le[w.number]<=99)return{type:ie.PLAY_CARD,payload:{card:w,increase:!1}}}}catch(O){y.e(O)}finally{y.f()}throw new Error("reached an edge case")}(t,t.turn);e.peerId=Object.keys(t.members).filter((function(e){return t.members[e]===t.players[t.turn]}))[0],r({type:ie.LOCAL_MOVE,payload:e}).catch(R)}),500);return function(){window.clearTimeout(e)}}}),[t]);var N=1===t.direction?">":"<",T=function(e){return Object(f.a)(l.a.mark((function n(){var a;return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a={type:ie.PLAY_CARD,payload:{card:e,increase:v,target:s}},t.turn!==g){n.next=6;break}return n.next=4,r(a).then((function(){return O("")})).catch(R);case 4:n.next=10;break;case 6:if(!k.includes(t.players[t.turn])){n.next=10;break}return a.peerId=Object.keys(t.members).filter((function(e){return t.members[e]===t.players[t.turn]}))[0],n.next=10,r({type:ie.LOCAL_MOVE,payload:a}).then((function(){return O("")})).catch(R);case 10:case"end":return n.stop()}}),n)})))},M=function(e){var n;return null===(n=t.playerDeck[e])||void 0===n?void 0:n.map((function(e){return c.a.createElement("button",{key:10*e.number+e.suit,onClick:T(e)},oe[e.suit]," ",e.number)}))},I=function(){var e=Object(f.a)(l.a.mark((function e(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r({type:ie.END}).catch(R);case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return c.a.createElement("div",null,c.a.createElement("div",null,c.a.createElement("h3",null,t.points),c.a.createElement("h6",null,t.players[t.turn],"'","s turn"),""!==w&&c.a.createElement("div",{style:{color:"red"}},w),void 0!==t.winner&&c.a.createElement("div",null,"winner is ",t.players[t.winner],c.a.createElement("button",{onClick:I},"again")),t.players.map((function(e,n){return c.a.createElement("span",{key:e,onClick:function(){return u(n)},style:{fontWeight:t.turn===n?"bold":"normal",textDecorationLine:t.dead[n]?"line-through":"none"}},e," ",N)})),c.a.createElement("div",null,0===k.length?M(g):S?c.a.createElement("button",{onClick:function(){return x(!1)}},"show ",t.players[L]):M(L)),c.a.createElement("div",null,"target: ",s),c.a.createElement("button",{onClick:function(){return m(!v)}},v?"+":"-")),c.a.createElement("div",null,t.logs.slice().reverse().map((function(e,t){return c.a.createElement("div",{key:t},e)}))))},Ee=function(e){var t=function(t){var n=se(de,new ue);return c.a.createElement(ve.Provider,{value:n},c.a.createElement(e,t))};return t.displayName="WithGameNetwork",t}((function(){switch(me().gameAppState){case Q.HOME:return c.a.createElement(be,null);case Q.ROOM:return c.a.createElement(ye,null);case Q.GAME:return c.a.createElement(je,null);default:throw new Error("unknown state")}}));o.a.render(c.a.createElement(Ee,null),document.getElementById("root")),s()}},[[133,1,2]]]);
//# sourceMappingURL=main.caf37e07.chunk.js.map